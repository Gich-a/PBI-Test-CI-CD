name: Power BI Deployment Pipeline

on:
  push:
    branches: [main] # Trigger deployment on push to main branch

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    name: Deploy PBIP to DEV Workspace

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üõ† Install PowerShell and FabricPS Module
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh -Command "Install-Module -Name FabricPS -Scope CurrentUser -Force"

      - name: üöÄ Deploy PBIP to DEV Workspace
        env:
          TENANT_ID: ${{ secrets.PBI_TENANT_ID }}
          CLIENT_ID: ${{ secrets.PBI_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.PBI_CLIENT_SECRET }}
          WORKSPACE_ID: ${{ secrets.PBI_WORKSPACE_ID_DEV }}
        run: |
          pwsh -Command "
            Import-Module FabricPS

            $ClientId = $env:CLIENT_ID
            $ClientSecret = $env:CLIENT_SECRET
            $TenantId = $env:TENANT_ID
            $WorkspaceId = $env:WORKSPACE_ID

            $SecurePassword = ConvertTo-SecureString $ClientSecret -AsPlainText -Force
            $Credential = New-Object System.Management.Automation.PSCredential ($ClientId, $SecurePassword)

            Connect-FabricTenant -TenantId $TenantId -Credential $Credential

            Write-Host 'üìÅ Validating PBIP structure...'
            if (!(Test-Path -Path './powerbi/AdventureWorks Report.pbip')) {
              throw 'PBIP project folder not found at expected location.'
            }

            Write-Host 'üì¶ Deploying PBIP project to workspace...'
            Publish-FabricArtifact -Path './powerbi/AdventureWorks Report.pbip' -WorkspaceId $WorkspaceId -Overwrite

            Write-Host '‚úÖ Deployment complete!'
          "
