name: Power BI Deployment Pipeline

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run PBIP Structural Tests

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: pip install -r requirements.txt

      - name: 🧪 Run PBIP structure tests
        run: python tests/tests.py powerbi/

  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy PBIP to DEV Workspace

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🛠 Install PowerShell and FabricPS
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh -Command "Install-Module -Name FabricPS -Scope CurrentUser -Force"

      - name: 🚀 Deploy PBIP to DEV Workspace
        env:
          TENANT_ID: ${{ secrets.PBI_TENANT_ID }}
          CLIENT_ID: ${{ secrets.PBI_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.PBI_CLIENT_SECRET }}
          WORKSPACE_ID: ${{ secrets.PBI_WORKSPACE_ID_DEV }}
        run: pwsh -Command @'
          Import-Module FabricPS

          $ClientId = "${env:CLIENT_ID}"
          $ClientSecret = "${env:CLIENT_SECRET}"
          $TenantId = "${env:TENANT_ID}"
          $WorkspaceId = "${env:WORKSPACE_ID}"

          if (-not $ClientId -or -not $ClientSecret -or -not $TenantId -or -not $WorkspaceId) {
            throw "🔐 Missing one or more required environment variables."
          }

          $SecurePassword = ConvertTo-SecureString $ClientSecret -AsPlainText -Force
          $Credential = New-Object System.Management.Automation.PSCredential ($ClientId, $SecurePassword)

          Connect-FabricTenant -TenantId $TenantId -Credential $Credential

          Write-Host "📁 Verifying PBIP project folder..."
          if (!(Test-Path -Path './powerbi/AdventureWorks Report.pbip')) {
            throw "❌ PBIP folder not found at './powerbi/AdventureWorks Report.pbip'."
          }

          Write-Host "📦 Deploying PBIP artifact to workspace..."
          Publish-FabricArtifact -Path './powerbi/AdventureWorks Report.pbip' -WorkspaceId $WorkspaceId -Overwrite

          Write-Host "✅ Deployment successful!"
          '@