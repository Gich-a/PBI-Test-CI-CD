name: Deploy Power BI

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest

    env:
      TENANT_ID:       ${{ secrets.PBI_TENANT_ID }}
      CLIENT_ID:       ${{ secrets.PBI_CLIENT_ID }}
      CLIENT_SECRET:   ${{ secrets.PBI_CLIENT_SECRET }}
      WORKSPACE_ID:    ${{ secrets.PBI_WORKSPACE_ID_DEV }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install Power BI PowerShell Modules
        shell: pwsh
        run: Install-Module -Name MicrosoftPowerBIMgmt -Force -AcceptLicense

      - name: üß™ Confirm Environment Variables
        shell: pwsh
        run: |
          Write-Host "TENANT_ID: $env:TENANT_ID"
          Write-Host "CLIENT_ID: $env:CLIENT_ID"
          Write-Host "WORKSPACE_ID: $env:WORKSPACE_ID"
          # Write-Host "CLIENT_SECRET: $env:CLIENT_SECRET"  # ‚ùå Avoid echoing secrets

      - name: ‚úÖ Verify and Run Deployment Script
        shell: pwsh
        run: |
          if (!(Test-Path "scripts/deploy-pbip.ps1")) {
            throw "‚ùå Script file not found at 'scripts/deploy-pbip.ps1'"
          }
          & "scripts/deploy-pbip.ps1"
